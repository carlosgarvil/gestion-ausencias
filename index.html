<!DOCTYPE html>
<html lang="es">

<head>
  <meta charset="UTF-8" />
  <title>Gestión de ausencias - IES Polígono Sur</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="stylesheet" href="style.css" />
  <link rel="apple-touch-icon" sizes="180x180" href="img/apple-touch-icon.png" />
  <link rel="icon" type="image/png" sizes="32x32" href="img/favicon-32x32.png" />
  <link rel="icon" type="image/png" sizes="16x16" href="img/favicon-16x16.png" />
  <link rel="shortcut icon" href="img/favicon.ico" />
  <meta name="msapplication-TileColor" content="#2b5797" />
  <meta name="msapplication-TileImage" content="img/android-chrome-192x192.png" />
  <meta name="theme-color" content="#ffffff" />
</head>

<body>
  <div id="app">
    <h1>Gestión de ausencias del profesorado</h1>

    <section id="login-section" v-if="!isLoggedIn">
      <h2>Acceso</h2>
      <form @submit.prevent="handleLogin">
        <label>
          Correo
          <input type="email" v-model="loginForm.email" required />
        </label>
        <label>
          Contraseña
          <input type="password" v-model="loginForm.password" required />
        </label>
        <button type="submit">Entrar</button>
        <div v-if="loginMessage" class="message" :class="loginMessageType">{{ loginMessage }}</div>
      </form>
    </section>

    <section id="app-section" v-else>
      <header class="app-header">
        <div class="header-left">
          <span class="session-text">
            Sesión iniciada como <strong>{{ userEmail }}</strong>
          </span>
        </div>
        <button id="btn-logout" type="button" class="btn-logout" @click="handleLogout">Cerrar sesión</button>
      </header>

      <nav class="top-nav">
        <a class="nav-link active" href="index.html">Ausencias</a>
        <a class="nav-link" href="panel.html">Panel</a>
        <a class="nav-link" href="justificaciones.html">Justificantes</a>
        <a class="nav-link" href="profesorado.html">Profesorado</a>
        <a class="nav-link" href="gestion_profesorado.html">Gestión del profesorado</a>
        <a class="nav-link" href="permisos.html">Permisos</a>
        <a class="nav-link" href="ayuda.html">Ayuda</a>
      </nav>

      <div>
        <div class="app-grid">
          <section id="form-section">
            <h2>Registro de ausencias</h2>
            <ul>
              <li> <strong>Una fecha</strong> -> crea una ausencia individual.</li>
              <li> <strong>Con "Fecha hasta"</strong> -> se genera una ausencia por cada día en el rango indicado.
              </li>
            </ul>
            <form id="absence-form" @submit.prevent="handleAbsenceSubmit">
              <label>
                Docente
                <select v-model="absenceForm.teacher" required>
                  <option value="">Selecciona…</option>
                  <option v-for="teacher in teachers" :key="teacher.name" :value="teacher.name">{{ teacher.name }}
                  </option>
                </select>
              </label>

              <label>
                Fecha desde
                <input type="date" v-model="absenceForm.dateFrom" required />
              </label>

              <label>
                Fecha hasta (opcional)
                <input type="date" v-model="absenceForm.dateTo" />
              </label>

              <label>
                Hora inicial (tramo)
                <select v-model.number="absenceForm.startSlot" required>
                  <option v-for="slot in slotOptions" :key="slot.value" :value="slot.value">{{ slot.label }}</option>
                </select>
              </label>

              <label>
                Hora final (tramo)
                <select v-model.number="absenceForm.endSlot" required>
                  <option v-for="slot in slotOptions" :key="`end-${slot.value}`" :value="slot.value">{{ slot.label }}
                  </option>
                </select>
              </label>

              <label>
                Motivo (opcional)
                <textarea v-model="absenceForm.reason" rows="2"></textarea>
              </label>

              <button type="submit" class="btn-save">Guardar ausencia</button>
              <div v-if="absenceMessage" class="message" :class="absenceMessageType">{{ absenceMessage }}</div>
            </form>
          </section>

          <section id="list-section">
            <h2>Ausencias del día</h2>
            <label>
              Fecha
              <input type="date" v-model="listDate" />
            </label>
            <button type="button" id="btn-refresh-list" class="btn-refresh"
              @click="loadAbsencesForDate">Actualizar</button>

            <div id="list-container" class="absence-list">
              <p v-if="loadingAbsences">Cargando ausencias…</p>
              <p v-else-if="!absences.length">No hay ausencias registradas para este día.</p>
              <article v-for="absence in absences" :key="absence.id" class="absence-item">
                <div class="absence-main" @click="toggleAbsenceEdit(absence)">
                  <strong>{{ absence.teacher_name }}</strong>
                  <div class="absence-meta">{{ formatSlotLabel(absence.start_slot, absence.end_slot) }}</div>
                  <div v-if="absence.reason" class="absence-meta">Motivo: {{ absence.reason }}</div>
                </div>
                <div class="absence-actions">
                  <button type="button" class="btn-delete" @click="deleteAbsence(absence.id)">Eliminar</button>
                </div>
                <div class="absence-edit" v-if="absence.editing">
                  <p class="absence-edit-title">Editar tramos</p>
                  <div class="absence-edit-controls">
                    <select v-model.number="absence.editStart">
                      <option v-for="slot in slotOptions" :key="`edit-start-${slot.value}`" :value="slot.value">{{
                        slot.label }}</option>
                    </select>
                    <select v-model.number="absence.editEnd">
                      <option v-for="slot in slotOptions" :key="`edit-end-${slot.value}`" :value="slot.value">{{
                        slot.label }}</option>
                    </select>
                  </div>
                  <div class="absence-edit-buttons">
                    <button type="button" class="btn-save" @click="saveAbsenceSlots(absence)">Guardar</button>
                    <button type="button" @click="cancelAbsenceEdit(absence)">Cancelar</button>
                  </div>
                  <div v-if="absence.editMessage" class="absence-edit-message" :class="absence.editMessageType">
                    {{ absence.editMessage }}
                  </div>
                </div>
              </article>
            </div>
          </section>
        </div>
      </div>
    </section>
  </div>

  <script src="https://unpkg.com/vue@3/dist/vue.global.prod.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="script.js"></script>
</body>

</html>



