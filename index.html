<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Gesti√≥n de ausencias - IES Pol√≠gono Sur</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="stylesheet" href="style.css" />
</head>
<body>
  <div id="app">
    <h1>Gesti√≥n de ausencias del profesorado</h1>

    <section id="login-section" v-if="!isLoggedIn">
      <h2>Acceso</h2>
      <form @submit.prevent="handleLogin">
        <label>
          Correo
          <input type="email" v-model="loginForm.email" required />
        </label>
        <label>
          Contrase√±a
          <input type="password" v-model="loginForm.password" required />
        </label>
        <button type="submit">Entrar</button>
        <div v-if="loginMessage" class="message" :class="loginMessageType">{{ loginMessage }}</div>
      </form>
    </section>

    <section id="app-section" v-else>
      <header class="app-header">
        <div class="header-left">
          <span class="session-text">
            Sesi√≥n iniciada como <strong>{{ userEmail }}</strong>
          </span>
        </div>
        <button id="btn-logout" type="button" class="btn-logout" @click="handleLogout">Cerrar sesi√≥n</button>
      </header>

      <nav class="top-nav">
        <button
          v-for="item in menuItems"
          :key="item.value"
          type="button"
          class="nav-link"
          :class="{ active: activeMenu === item.value }"
          @click="activeMenu = item.value"
        >
          {{ item.label }}
        </button>
      </nav>

      <div v-show="activeMenu === 'ausencias'">
        <div class="app-grid">
          <section id="form-section">
            <h2>Registro de ausencias</h2>
            <ul>
              <li>üìÖ <strong>Una fecha</strong> ‚Üí crea una ausencia individual.</li>
              <li>üóìÔ∏è <strong>Con "Fecha hasta"</strong> ‚Üí se genera una ausencia por cada d√≠a en el rango indicado.</li>
            </ul>
            <form id="absence-form" @submit.prevent="handleAbsenceSubmit">
              <label>
                Docente
                <select v-model="absenceForm.teacher" required>
                  <option value="">Selecciona‚Ä¶</option>
                  <option v-for="teacher in teachers" :key="teacher.name" :value="teacher.name">{{ teacher.name }}</option>
                </select>
              </label>

              <label>
                Fecha desde
                <input type="date" v-model="absenceForm.dateFrom" required />
              </label>

              <label>
                Fecha hasta (opcional)
                <input type="date" v-model="absenceForm.dateTo" />
              </label>

              <label>
                Hora inicial (tramo)
                <select v-model.number="absenceForm.startSlot" required>
                  <option v-for="slot in slotOptions" :key="slot.value" :value="slot.value">{{ slot.label }}</option>
                </select>
              </label>

              <label>
                Hora final (tramo)
                <select v-model.number="absenceForm.endSlot" required>
                  <option v-for="slot in slotOptions" :key="`end-${slot.value}`" :value="slot.value">{{ slot.label }}</option>
                </select>
              </label>

              <label>
                Motivo (opcional)
                <textarea v-model="absenceForm.reason" rows="2"></textarea>
              </label>

              <button type="submit" class="btn-save">Guardar ausencia</button>
              <div v-if="absenceMessage" class="message" :class="absenceMessageType">{{ absenceMessage }}</div>
            </form>
          </section>

          <section id="list-section">
            <h2>Ausencias del d√≠a</h2>
            <label>
              Fecha
              <input type="date" v-model="listDate" />
            </label>
            <button type="button" id="btn-refresh-list" class="btn-refresh" @click="loadAbsencesForDate">Actualizar</button>

            <div id="list-container" class="absence-list">
              <p v-if="loadingAbsences">Cargando ausencias‚Ä¶</p>
              <p v-else-if="!absences.length">No hay ausencias registradas para este d√≠a.</p>
              <article v-for="absence in absences" :key="absence.id" class="absence-item">
                <div class="absence-main" @click="toggleAbsenceEdit(absence)">
                  <strong>{{ absence.teacher_name }}</strong>
                  <div class="absence-meta">{{ formatSlotLabel(absence.start_slot, absence.end_slot) }}</div>
                  <div v-if="absence.reason" class="absence-meta">Motivo: {{ absence.reason }}</div>
                </div>
                <div class="absence-actions">
                  <button type="button" class="btn-delete" @click="deleteAbsence(absence.id)">Eliminar</button>
                </div>
                <div class="absence-edit" v-if="absence.editing">
                  <p class="absence-edit-title">Editar tramos</p>
                  <div class="absence-edit-controls">
                    <select v-model.number="absence.editStart">
                      <option v-for="slot in slotOptions" :key="`edit-start-${slot.value}`" :value="slot.value">{{ slot.label }}</option>
                    </select>
                    <select v-model.number="absence.editEnd">
                      <option v-for="slot in slotOptions" :key="`edit-end-${slot.value}`" :value="slot.value">{{ slot.label }}</option>
                    </select>
                  </div>
                  <div class="absence-edit-buttons">
                    <button type="button" class="btn-save" @click="saveAbsenceSlots(absence)">Guardar</button>
                    <button type="button" @click="cancelAbsenceEdit(absence)">Cancelar</button>
                  </div>
                  <div
                    v-if="absence.editMessage"
                    class="absence-edit-message"
                    :class="absence.editMessageType"
                  >
                    {{ absence.editMessage }}
                  </div>
                </div>
              </article>
            </div>
          </section>
        </div>
      </div>

      <section id="teachers-section" v-show="activeMenu === 'profesorado'">
        <div class="teacher-schedule-header">
          <div>
            <h2>üë©‚Äçüè´ Profesorado</h2>
            <p class="absence-meta">
              Consulta el horario semanal completo del docente, incluyendo horas marcadas como ‚Äúno visibles‚Äù.
            </p>
          </div>
          <div class="teacher-schedule-controls">
            <label>
              Profesor/a
              <select v-model="teacherScheduleTeacher">
                <option value="">Selecciona‚Ä¶</option>
                <option v-for="teacher in teachers" :key="`schedule-${teacher.name}`" :value="teacher.name">
                  {{ teacher.name }}
                </option>
              </select>
            </label>
            <button
              type="button"
              class="btn-refresh"
              @click="loadTeacherSchedule"
              :disabled="!teacherScheduleTeacher || loadingTeacherSchedule"
            >
              Actualizar
            </button>
          </div>
        </div>

        <div class="teacher-schedule-content">
          <p v-if="!teacherScheduleTeacher" class="absence-meta">Selecciona un docente para cargar su horario.</p>
          <p v-else-if="loadingTeacherSchedule" class="absence-meta">Cargando horario‚Ä¶</p>
          <p v-else-if="teacherScheduleMessage" class="absence-meta">{{ teacherScheduleMessage }}</p>
          <div v-else class="teacher-schedule-grid">
            <table class="schedule-table">
              <thead>
                <tr>
                  <th>Franja</th>
                  <th v-for="day in teacherScheduleDays" :key="`day-${day.value}`">{{ day.label }}</th>
                </tr>
              </thead>
              <tbody>
                <tr v-for="row in teacherScheduleGrid" :key="`slot-${row.slotValue}`">
                  <th>{{ row.slotLabel }}</th>
                  <td v-for="(cell, index) in row.days" :key="`cell-${row.slotValue}-${index}`">
                    <div v-if="cell.length" class="schedule-cell">
                      <article
                        v-for="(classInfo, idx) in cell"
                        :key="`class-${row.slotValue}-${index}-${idx}`"
                        class="schedule-class"
                        :class="{ 'schedule-class--hidden': !classInfo.visible }"
                      >
                        <p class="schedule-class-main">{{ classInfo.subject }}</p>
                        <p v-if="classInfo.group" class="schedule-class-meta">{{ classInfo.group }}</p>
                        <p v-if="classInfo.classroom" class="schedule-class-meta">Aula: {{ classInfo.classroom }}</p>
                        <span v-if="!classInfo.visible" class="schedule-badge">No visible</span>
                        <p v-if="classInfo.notes" class="schedule-class-notes">{{ classInfo.notes }}</p>
                      </article>
                    </div>
                    <div v-else class="schedule-cell schedule-cell--empty">‚Äî</div>
                  </td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>
      </section>

      <section id="panel-section" v-show="activeMenu === 'panel'">
        <div class="panel-header">
          <h2>Panel del centro</h2>
          <div class="panel-controls">
            <label>
              Fecha
              <input type="date" v-model="panelDate" />
            </label>
            <button type="button" class="btn-refresh" @click="loadPanelData">Actualizar</button>
          </div>
        </div>

        <div class="panel-table-wrapper">
          <p v-if="loadingPanel">Cargando clases‚Ä¶</p>
          <p v-else-if="panelMessage">{{ panelMessage }}</p>
          <table v-else class="panel-table">
            <thead>
              <tr>
                <th>Franja horaria</th>
                <th>Grupo</th>
                <th>Materia</th>
                <th>Aula</th>
                <th>Profesor/a ausente</th>
              </tr>
            </thead>
            <tbody>
              <tr v-for="(row, index) in panelRows" :key="row.key || `${row.teacher}-${index}-${row.slotValue}`">
                <td v-if="row.showSlotLabel" :rowspan="row.slotRowSpan">{{ row.slotLabel }}</td>
                <td>{{ row.group }}</td>
                <td>{{ row.subject }}</td>
                <td>{{ row.classroom }}</td>
                <td>{{ row.teacher }}</td>
              </tr>
            </tbody>
          </table>
        </div>
      </section>

      <section id="justifications-section" v-show="activeMenu === 'justificaciones'">
        <div class="justifications-header">
          <h2>üìã Justificantes</h2>
          <label class="month-picker">
            Mes
            <input type="month" v-model="justificationsMonth" />
          </label>
        </div>

        <div class="justifications-content">
          <p v-if="loadingJustifications">Cargando ausencias‚Ä¶</p>
          <p v-else-if="justificationsMessage">{{ justificationsMessage }}</p>
          <p v-else-if="!justifications.length">No hay ausencias registradas para este mes.</p>

          <table v-else class="justifications-table">
            <thead>
              <tr>
                <th>Docente</th>
                <th>Fecha</th>
                <th>Inicio</th>
                <th>Fin</th>
                <th>Estado</th>
              </tr>
            </thead>
            <tbody>
              <tr v-for="justification in justifications" :key="justification.id">
                <td>{{ justification.teacher_name }}</td>
                <td>{{ formatDateForDisplay(justification.date) }}</td>
                <td>{{ justification.start_slot }}</td>
                <td>{{ justification.end_slot }}</td>
                <td>
                  <select
                    class="status-select"
                    :value="justification.status"
                    @change="updateJustificationStatus(justification, $event.target.value)"
                  >
                    <option
                      v-for="option in justificationStatusOptions"
                      :key="option.value"
                      :value="option.value"
                    >
                      {{ option.label }}
                    </option>
                  </select>
                  <span
                    v-if="justification.statusMessage"
                    class="status-message"
                    :class="justification.statusMessageType"
                  >
                    {{ justification.statusMessage }}
                  </span>
                </td>
              </tr>
            </tbody>
          </table>
        </div>
      </section>

      <section id="substitutions-section" v-show="activeMenu === 'sustituciones'">
        <h2>üîÅ Gesti√≥n de sustituciones</h2>
        <p>
          En caso de sustituci√≥n, las ausencias enviadas desde el formulario deben mostrar el nombre correcto en el panel del centro.
          Indica siempre el cambio respecto al <strong>docente titular</strong> y revierte la sustituci√≥n cuando finalice.
        </p>
        <p>Puede revertir la sustituci√≥n con el bot√≥n ‚ÄúQuitar sustituto‚Äù.</p>

        <div class="substitutions-layout">
          <div class="substitutions-block">
            <h3>Sustituciones activas</h3>
            <p class="absence-meta">Si el correo del formulario es distinto al del titular, se considera que hay una sustituci√≥n activa.</p>
            <table class="substitutions-table" v-if="substitutions.length">
              <thead>
                <tr>
                  <th>Titular</th>
                  <th>Nombre en panel</th>
                  <th>Email formulario</th>
                  <th>Acciones</th>
                </tr>
              </thead>
              <tbody>
                <tr v-for="row in substitutions" :key="row.email">
                  <td>{{ row.name }}</td>
                  <td>{{ row.display_name || row.name }}</td>
                  <td>{{ row.email_form }}</td>
                  <td>
                    <button type="button" class="btn-delete" @click="removeSubstitution(row)">Quitar sustituto</button>
                  </td>
                </tr>
              </tbody>
            </table>
            <p id="substitutions-empty" class="absence-meta" v-else>No hay sustituciones activas.</p>
          </div>

          <div class="substitutions-block">
            <h3>A√±adir / cambiar sustituto</h3>
            <form id="substitution-form" @submit.prevent="handleSubstitutionSubmit">
              <label>
                Profesor titular
                <select v-model="substitutionForm.teacher" required>
                  <option value="">Selecciona titular‚Ä¶</option>
                  <option v-for="teacher in substitutionTeachers" :key="teacher.name" :value="teacher.name">{{ teacher.name }}</option>
                </select>
              </label>

              <label>
                Nombre que se mostrar√° en el panel (Apellidos, Nombre)
                <input type="text" v-model="substitutionForm.displayName" required />
              </label>

              <label>
                Email del sustituto
                <input type="email" v-model="substitutionForm.emailForm" required />
              </label>

              <button type="submit" class="btn-save">Guardar sustituci√≥n</button>
            </form>
          </div>
        </div>
      </section>

      <section id="help-section" v-show="activeMenu === 'ayuda'">
        <h2>Ayuda y buenas pr√°cticas</h2>
        <article class="help-block">
          <h3>Cu√°ndo registrar una ausencia</h3>
          <ul>
            <li>Usa el formulario de ‚ÄúRegistro de ausencias‚Äù para comunicar ausencias planificadas o sobrevenidas.</li>
            <li>Para ausencias de varios d√≠as, utiliza los campos <strong>Fecha desde</strong> y <strong>Fecha hasta</strong>. El sistema genera un registro diario.</li>
            <li>Completa los tramos horarios afectados. Puedes modificarlos posteriormente desde la lista de ausencias.</li>
            <li>Las ausencias se guardan autom√°ticamente cuando el profesorado rellena el formulario de Google Classroom; por tanto pueden aparecer registradas sin intervenci√≥n manual en esta aplicaci√≥n.</li>
            <li>Por defecto, las ausencias creadas se marcan como ausencia de d√≠a completo (tramos <strong>1‚Äì14</strong>). Si el profesor se reincorpora durante la jornada, edita los tramos de esa ausencia para eliminar los tramos ya cubiertos y evitar que siga apareciendo en el panel.</li>
            <li>El panel muestra exactamente la informaci√≥n que se visualiza en la TV de la Sala del Profesorado: cualquier cambio en los tramos en este sistema se reflejar√° en dicha TV tras actualizar el panel.</li>
          </ul>
        </article>

        <article class="help-block">
          <h3>Consulta de ausencias por fecha</h3>
          <ul>
            <li>Selecciona un d√≠a en ‚ÄúAusencias del d√≠a‚Äù y pulsa <strong>Actualizar</strong> para ver los registros ordenados por docente.</li>
            <li>Pulsa sobre una ausencia para editar los tramos y usa el bot√≥n rojo para eliminarla si ha sido un error.</li>
            <li>La informaci√≥n sensible (motivos) nunca aparece en los paneles p√∫blicos, solo en esta vista protegida.</li>
          </ul>
        </article>

        <article class="help-block">
          <h3>Gesti√≥n de sustituciones</h3>
          <ul>
            <li>El panel de clases a cubrir identifica autom√°ticamente una sustituci√≥n cuando el correo del formulario difiere del titular.</li>
            <li>Desde la pesta√±a ‚ÄúSustituciones‚Äù puedes asignar el nombre y correo del sustituto para que el panel muestre los datos correctos.</li>
            <li>Cuando el titular se reincorpore, usa ‚ÄúQuitar sustituto‚Äù para volver a mostrar su nombre y correo.</li>
          </ul>
        </article>

        <article class="help-block">
          <h3>Seguridad y acceso</h3>
          <ul>
            <li>El acceso se realiza mediante Supabase Auth. No compartas tu cuenta.</li>
            <li>Las tablas `teachers`, `absences` y el horario est√°n protegidos con RLS en Supabase para evitar accesos no autorizados.</li>
            <li>El panel p√∫blico solo expone la informaci√≥n imprescindible para la organizaci√≥n diaria.</li>
          </ul>
        </article>
      </section>
    </section>
  </div>

  <script src="https://unpkg.com/vue@3/dist/vue.global.prod.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="script.js"></script>
</body>
</html>
