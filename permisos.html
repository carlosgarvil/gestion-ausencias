<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Gestión de ausencias - IES Polígono Sur</title>
  <link rel="stylesheet" href="style.css" />
  <link rel="apple-touch-icon" sizes="180x180" href="img/apple-touch-icon.png" />
  <link rel="icon" type="image/png" sizes="32x32" href="img/favicon-32x32.png" />
  <link rel="icon" type="image/png" sizes="16x16" href="img/favicon-16x16.png" />
  <link rel="shortcut icon" href="img/favicon.ico" />
  <meta name="msapplication-TileColor" content="#2b5797" />
  <meta name="msapplication-TileImage" content="img/android-chrome-192x192.png" />
  <meta name="theme-color" content="#ffffff" />
  <style>
    :root { font-family: system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, "Helvetica Neue", Arial; }
    body { color: #111; }
    .muted { color: #555; margin: 0 0 14px; }
    .panel { border: 1px solid #ddd; border-radius: 10px; padding: 14px; margin: 12px 0; }

    /* Layout más compacto */
    .row { display: flex; gap: 12px; flex-wrap: wrap; align-items: end; }
    .field { display: flex; flex-direction: column; gap: 6px; }
    label { font-size: 12px; color: #333; }

    input[type="date"], input[type="text"], input[type="number"], input[type="file"] {
      padding: 8px 10px; border: 1px solid #ccc; border-radius: 8px; font-size: 14px;
    }

    /* Ajuste de tamaños */
    .w-file { width: 360px; }
    .w-date { width: 180px; }
    .w-num  { width: 110px; }
    .w-letter { width: 110px; text-transform: uppercase; }

    button {
      padding: 10px 12px; border: 1px solid #ccc; border-radius: 10px;
      background: #fafafa; cursor: pointer; font-weight: 600;
    }
    button:hover { background: #f0f0f0; }
    .actions { display: flex; gap: 10px; align-items: end; flex-wrap: wrap; }

    .pill { display: inline-block; padding: 3px 8px; border-radius: 999px; font-size: 12px; border: 1px solid #ddd; background: #f8f8f8; }
    .ok { background: #ecfdf5; border-color: #a7f3d0; color: #065f46; }
    .bad { background: #fef2f2; border-color: #fecaca; color: #7f1d1d; }
    .warn { background: #fffbeb; border-color: #fde68a; color: #92400e; }

    table { width: 100%; border-collapse: collapse; margin-top: 10px; }
    th, td { border-bottom: 1px solid #eee; padding: 8px 8px; vertical-align: top; }
    th { text-align: left; font-size: 12px; color: #333; background: #fafafa; position: sticky; top: 0; }
    td { font-size: 13px; }
    .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; }
    .small { font-size: 12px; color: #444; }
    details summary { cursor: pointer; font-weight: 700; }
    .footer-note { color: #444; font-size: 12px; margin-top: 10px; }
    .footer-note-inline { display: inline-block; margin-top: 0; margin-left: 8px; vertical-align: middle; }
    .info-icon { position: relative; display: inline-block; cursor: help; color: #2b6cb0; font-weight: 700; }
    .info-icon:focus { outline: none; }
    .info-icon .tooltip {
      display: none;
      position: absolute;
      left: 50%;
      transform: translateX(-50%);
      bottom: 125%;
      background: #222;
      color: #fff;
      padding: 6px 8px;
      border-radius: 6px;
      font-size: 12px;
      white-space: nowrap;
      z-index: 20;
      box-shadow: 0 4px 10px rgba(0,0,0,0.15);
    }
    .info-icon .tooltip::after {
      content: "";
      position: absolute;
      top: 100%;
      left: 50%;
      transform: translateX(-50%);
      border-width: 6px;
      border-style: solid;
      border-color: #222 transparent transparent transparent;
    }
    .info-icon:hover .tooltip,
    .info-icon:focus .tooltip {
      display: block;
    }
    .error { color: #b00020; font-weight: 700; }
  </style>
</head>

<body>
  <div id="app">
    <h1>Gestión de ausencias del profesorado</h1>

    <section id="login-section" v-if="!isLoggedIn">
      <h2>Acceso</h2>
      <form @submit.prevent="handleLogin">
        <label>
          Correo
          <input type="email" v-model="loginForm.email" required />
        </label>
        <label>
          Contraseña
          <input type="password" v-model="loginForm.password" required />
        </label>
        <button type="submit">Entrar</button>
        <div v-if="loginMessage" class="message" :class="loginMessageType">{{ loginMessage }}</div>
      </form>
    </section>

    <section id="app-section" v-else>
      <header class="app-header">
        <div class="header-left">
          <span class="session-text">
            Sesión iniciada como <strong>{{ userEmail }}</strong>
          </span>
        </div>
        <button id="btn-logout" type="button" class="btn-logout" @click="handleLogout">Cerrar sesión</button>
      </header>

      <nav class="top-nav">
        <a class="nav-link" href="index.html">Ausencias</a>
        <a class="nav-link" href="panel.html">Panel</a>
        <a class="nav-link" href="justificaciones.html">Justificantes</a>
        <a class="nav-link" href="profesorado.html">Profesorado</a>
        <a class="nav-link" href="gestion_profesorado.html">Gestión del profesorado</a>
        <a class="nav-link active" href="permisos.html">Permisos</a>
        <a class="nav-link" href="ayuda.html">Ayuda</a>
      </nav>

      <section id="permisos-section">
        <h2>Gestión de permisos retribuidos.</h2>
        <p class="muted">En la ruta de Séneca "Personal > Ausencias > Solicitud de Permisos y Licencias (Anexo I)", exporta en formato CSV todas las solicitudes con todas las columnas. El programa filtrará el permiso P27 y calculará los próximos permisos que deben ser aceptados o rechazados según la normativa. El cálculo se hace local en tu navegador, evitando problemas de privacidad de datos.</p>

        <div class="panel">
          <div class="row">
            <div class="field">
              <label>CSV (exportación Séneca)<span class="footer-note footer-note-inline">
                <span class="info-icon" tabindex="0" role="img" aria-label="Orden circular">
                  &#8505;
                  <span class="tooltip">Columnas esperadas: Nombre, Motivo, Fecha inicio, Fecha fin, Estado.</span>
                </span>
              </span></label>
              <input id="csvFile" class="w-file" type="file" accept=".csv,text/csv" />
            </div>

            <div class="field">
              <label>Inicio periodo lectivo</label>
              <input id="lectivoInicio" class="w-date" type="date" />
            </div>

            <div class="field">
              <label>Fin periodo lectivo</label>
              <input id="lectivoFin" class="w-date" type="date" />
            </div>

            <div class="field">
              <label>Cupo / día</label>
              <input id="cupoDia" class="w-num" type="number" min="1" max="20" value="5" />
            </div>

            <div class="field">
              <label>Letra desempate<span class="footer-note footer-note-inline">
                <span class="info-icon" tabindex="0" role="img" aria-label="Orden circular">
                  &#8505;
                  <span class="tooltip">Orden circular: H→I→...→Z→A→...</span>
                </span>
              </span></label>
              <input id="letra" class="w-letter" type="text" maxlength="1" />
              
            </div>

            <div class="actions">
              <button id="runBtn">Calcular</button>
              <button id="exportBtn" disabled>Exportar resultado CSV</button>
              <span id="status" class="pill">Estado: Sin calcular</span>
            </div>
          </div>

          <div id="err" class="error" style="margin-top:10px; display:none;"></div>
        </div>

        <div class="panel">
          <details open>
            <summary>Resumen por día (P.27 lectivo)</summary>
            <div id="summary"></div>
          </details>
        </div>

        <div class="panel">
          <details open>
            <summary>Detalle de solicitudes (P.27)</summary>
            <div id="tableWrap"></div>
          </details>
        </div>
        <div class="panel">
          <details open>
            <summary>Días que han llegado al máximo (cupo completo)</summary>
            <p class="small">Lista limpia (un día por línea) para copiar/pegar:</p>
            <textarea id="maxDays" rows="8" style="width:100%; font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, 'Liberation Mono', 'Courier New', monospace; font-size: 13px; padding: 10px; border-radius: 10px; border: 1px solid #ddd;" readonly></textarea>
          </details>
        </div>

        <p class="footer-note">
          <b>Interpretación aplicada:</b> "Aprobada" ocupa cupo del día; las "Pendientes" se ordenan por prioridad
          (sin P.27 lectivo aprobado en el curso) y, si hay empate, por orden alfabético circular desde la letra indicada.
        </p>
      </section>
    </section>
  </div>

  <script src="https://unpkg.com/vue@3/dist/vue.global.prod.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="script.js"></script>
  <script>
  let permisosInitialized = false;

  function initPermisos() {
    if (permisosInitialized) return true;

    const csvFile = document.getElementById("csvFile");
    if (!csvFile) return false;

    permisosInitialized = true;

    /** =========================
     *  Defaults "hardcoded" (para que cambies el año tocando código)
     *  ========================= */
    const DEFAULT_LECTIVO_INI = "2025-09-15";
    const DEFAULT_LECTIVO_FIN = "2026-06-22";
    const DEFAULT_LETRA = "H";

    /** =========================
     *  Utilidades texto/fechas
     *  ========================= */
    function normalizeForSort(s) {
      if (s == null) return "";
      let up = String(s).trim().toUpperCase();
      up = up.replace(/Ñ/g, "__ENYE__");
      up = up.normalize("NFD").replace(/[\u0300-\u036f]/g, "");
      up = up.replace(/__ENYE__/g, "Ñ");
      up = up.replace(/[^A-ZÑ ,.'-]/g, " ").replace(/\s+/g, " ").trim();
      return up;
    }

    function parseDateES(ddmmyyyy) {
      if (!ddmmyyyy) return null;
      const m = String(ddmmyyyy).trim().match(/^(\d{1,2})\/(\d{1,2})\/(\d{4})$/);
      if (!m) return null;
      const d = Number(m[1]), mo = Number(m[2]) - 1, y = Number(m[3]);
      const dt = new Date(y, mo, d);
      if (dt.getFullYear() !== y || dt.getMonth() !== mo || dt.getDate() !== d) return null;
      dt.setHours(0,0,0,0);
      return dt;
    }

    function toISODate(d) {
      const y = d.getFullYear();
      const m = String(d.getMonth() + 1).padStart(2, "0");
      const da = String(d.getDate()).padStart(2, "0");
      return `${y}-${m}-${da}`;
    }

    function* eachDayInclusive(start, end) {
      const cur = new Date(start.getTime());
      while (cur <= end) {
        yield new Date(cur.getTime());
        cur.setDate(cur.getDate() + 1);
      }
    }

    /** =========================
     *  Lectura de CSV con tildes bien
     *  ========================= */
    async function readFileTextWithEncoding(file) {
      const buf = await file.arrayBuffer();

      // Séneca suele venir en Windows-1252. Si no, UTF-8.
      const tryDecoders = [
        new TextDecoder("windows-1252", { fatal: false }),
        new TextDecoder("utf-8", { fatal: false })
      ];

      // Heurística simple: si hay muchos � en utf-8, usa 1252.
      const t1252 = tryDecoders[0].decode(buf);
      const tUtf8  = tryDecoders[1].decode(buf);

      const countReplacement = (s) => (s.match(/\uFFFD/g) || []).length;
      return (countReplacement(tUtf8) > countReplacement(t1252)) ? t1252 : tUtf8;
    }

    /** =========================
     *  CSV parser
     *  ========================= */
    function parseCSV(text) {
      const rows = [];
      let row = [];
      let field = "";
      let inQuotes = false;

      for (let i = 0; i < text.length; i++) {
        const c = text[i];

        if (inQuotes) {
          if (c === '"') {
            if (text[i + 1] === '"') { field += '"'; i++; }
            else { inQuotes = false; }
          } else {
            field += c;
          }
        } else {
          if (c === '"') inQuotes = true;
          else if (c === ",") { row.push(field); field = ""; }
          else if (c === "\n") {
            row.push(field); field = "";
            if (row.length && row[row.length - 1].endsWith("\r")) row[row.length - 1] = row[row.length - 1].slice(0, -1);
            if (row.some(v => String(v).trim() !== "")) rows.push(row);
            row = [];
          } else {
            field += c;
          }
        }
      }
      if (field.length || row.length) {
        row.push(field);
        if (row.length && row[row.length - 1].endsWith("\r")) row[row.length - 1] = row[row.length - 1].slice(0, -1);
        if (row.some(v => String(v).trim() !== "")) rows.push(row);
      }

      if (!rows.length) return { headers: [], data: [] };
      const headers = rows[0].map(h => String(h).trim());
      const data = rows.slice(1).map(r => {
        const obj = {};
        headers.forEach((h, idx) => obj[h] = (r[idx] ?? "").trim());
        return obj;
      });
      return { headers, data };
    }

    /** =========================
     *  Lógica P.27
     *  ========================= */
    const P27 = "P.27. Permisos por asuntos particulares retribuidos";
    const ALPHA = "ABCDEFGHIJKLMNÑOPQRSTUVWXYZ".split("");

    function alphaKeyFromLetter(surnameFirst, startLetter) {
      const norm = normalizeForSort(surnameFirst);
      const firstChar = norm[0] || "Z";
      const idxChar = ALPHA.indexOf(firstChar);
      const idxStart = ALPHA.indexOf(startLetter);
      if (idxChar === -1 || idxStart === -1) return 999;
      return (idxChar - idxStart + ALPHA.length) % ALPHA.length;
    }

    function getFirstSurname(fullName) {
      const txt = String(fullName || "");
      const parts = txt.split(",");
      const surnames = (parts[0] || "").trim();
      const first = surnames.split(/\s+/).filter(Boolean)[0] || surnames || txt;
      return first.trim();
    }

    function isEstadoAprobada(estado) { return normalizeForSort(estado).includes("APROBADA"); }
    function isEstadoRechazada(estado) { return normalizeForSort(estado).includes("RECHAZ"); }
    function isEstadoPendiente(estado) {
      const e = normalizeForSort(estado);
      return e.includes("PEND") || e.includes("PEN.");
    }

    function cursoEscolarFromDate(d) {
      const y = d.getFullYear();
      const m = d.getMonth() + 1;
      return (m >= 9) ? `${y}-${y+1}` : `${y-1}-${y}`;
    }
    function withinInclusive(d, a, b) { return d >= a && d <= b; }

    /** =========================
     *  UI
     *  ========================= */
    const els = {
      csvFile: document.getElementById("csvFile"),
      lectivoInicio: document.getElementById("lectivoInicio"),
      lectivoFin: document.getElementById("lectivoFin"),
      cupoDia: document.getElementById("cupoDia"),
      letra: document.getElementById("letra"),
      runBtn: document.getElementById("runBtn"),
      exportBtn: document.getElementById("exportBtn"),
      status: document.getElementById("status"),
      err: document.getElementById("err"),
      summary: document.getElementById("summary"),
      tableWrap: document.getElementById("tableWrap"),
      maxDays: document.getElementById("maxDays"),

    };

    let lastResultRows = [];
    let lastResultHeaders = [];

    function setError(msg) {
      els.err.style.display = msg ? "block" : "none";
      els.err.textContent = msg || "";
    }
    function setStatus(text, cls) {
      els.status.className = "pill " + (cls || "");
      els.status.textContent = text;
    }

    function escapeHtml(s) {
      return String(s ?? "")
        .replaceAll("&", "&amp;")
        .replaceAll("<", "&lt;")
        .replaceAll(">", "&gt;")
        .replaceAll('"', "&quot;")
        .replaceAll("'", "&#039;");
    }

    function renderSummary(byDay) {
      const days = Array.from(byDay.keys()).sort();
      if (!days.length) {
        els.summary.innerHTML = `<p class="small">No hay solicitudes P.27 en el periodo lectivo indicado.</p>`;
        if (els.maxDays) els.maxDays.value = "";
        return;
      }

      let html = `<table>
        <thead><tr>
          <th>Día</th><th>Total</th><th>Aprobadas (ocupan)</th><th>Pendientes</th><th>Cupo</th><th>Huecos</th><th>Entrarían</th><th>Fuera</th>
        </tr></thead><tbody>`;

      const maxedDays = [];

      for (const day of days) {
        const s = byDay.get(day);
        const free = Math.max(0, s.slots - s.approved);

        if ((s.approved + s.accepted) >= s.slots) {
          maxedDays.push(day);
        }

        html += `<tr>
          <td class="mono">${day}</td>
          <td>${s.total}</td>
          <td>${s.approved}</td>
          <td>${s.pending}</td>
          <td>${s.slots}</td>
          <td>${free}</td>
          <td><span class="pill ok">${s.accepted}</span></td>
          <td><span class="pill bad">${s.rejected}</span></td>
        </tr>`;
      }
      html += `</tbody></table>`;
      els.summary.innerHTML = html;

      if (els.maxDays) {
        els.maxDays.value = maxedDays.join("\n");
      }
    }


    function renderTable(rows) {
      if (!rows.length) {
        els.tableWrap.innerHTML = `<p class="small">Sin filas para mostrar.</p>`;
        return;
      }

      const head = `<table><thead><tr>
        <th>Decisión</th>
        <th>Día (lectivo)</th>
        <th>Nombre</th>
        <th>Estado (Séneca)</th>
        <th>Motivo</th>
        <th>Fecha inicio</th>
        <th>Fecha fin</th>
        <th>Razón</th>
      </tr></thead><tbody>`;

      const body = rows.map(r => {
        const pill = r.decision === "ACEPTAR"
          ? `<span class="pill ok">ACEPTAR</span>`
          : r.decision.startsWith("FUERA")
            ? `<span class="pill bad">${escapeHtml(r.decision)}</span>`
            : r.decision.startsWith("YA APROBADA")
              ? `<span class="pill warn">${escapeHtml(r.decision)}</span>`
              : r.decision.startsWith("YA RECHAZADA")
                ? `<span class="pill">${escapeHtml(r.decision)}</span>`
                : `<span class="pill">${escapeHtml(r.decision)}</span>`;

        return `<tr>
          <td>${pill}</td>
          <td class="mono">${escapeHtml(r.lectiveDayISO || "")}</td>
          <td>${escapeHtml(r.Nombre || "")}</td>
          <td>${escapeHtml(r.Estado || "")}</td>
          <td>${escapeHtml(r.Motivo || "")}</td>
          <td>${escapeHtml(r["Fecha inicio"] || "")}</td>
          <td>${escapeHtml(r["Fecha fin"] || "")}</td>
          <td class="small">${escapeHtml(r.reason || "")}</td>
        </tr>`;
      }).join("");

      els.tableWrap.innerHTML = head + body + `</tbody></table>`;
    }

    function downloadCSV(filename, headers, rows) {
      const esc = (v) => {
        const s = String(v ?? "");
        if (/[",\n\r]/.test(s)) return `"${s.replaceAll('"', '""')}"`;
        return s;
      };
      const lines = [];
      lines.push(headers.map(esc).join(","));
      for (const r of rows) lines.push(headers.map(h => esc(r[h])).join(","));
      const blob = new Blob([lines.join("\n")], { type: "text/csv;charset=utf-8" });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = filename;
      document.body.appendChild(a);
      a.click();
      a.remove();
      URL.revokeObjectURL(url);
    }

    els.exportBtn.addEventListener("click", () => {
      if (!lastResultRows.length) return;
      downloadCSV("resultado_p27_lectivo.csv", lastResultHeaders, lastResultRows);
    });

    /** Set defaults al cargar */
    (function initDefaults(){
      els.lectivoInicio.value = DEFAULT_LECTIVO_INI;
      els.lectivoFin.value = DEFAULT_LECTIVO_FIN;
      els.letra.value = DEFAULT_LETRA;
    })();

    els.runBtn.addEventListener("click", async () => {
      setError("");
      setStatus("Calculando...", "warn");
      els.exportBtn.disabled = true;

      const file = els.csvFile.files?.[0];
      if (!file) { setStatus("Falta CSV", "bad"); setError("Selecciona un CSV primero."); return; }

      const iniStr = els.lectivoInicio.value;
      const finStr = els.lectivoFin.value;
      if (!iniStr || !finStr) { setStatus("Faltan fechas", "bad"); setError("Indica inicio y fin del periodo lectivo."); return; }

      const lectIni = new Date(iniStr); lectIni.setHours(0,0,0,0);
      const lectFin = new Date(finStr); lectFin.setHours(0,0,0,0);
      if (lectFin < lectIni) { setStatus("Fechas incorrectas", "bad"); setError("El fin no puede ser anterior al inicio."); return; }

      const cupo = Number(els.cupoDia.value || 5);
      if (!Number.isFinite(cupo) || cupo < 1) { setStatus("Cupo inválido", "bad"); setError("El cupo debe ser >= 1."); return; }

      let letra = normalizeForSort(els.letra.value || DEFAULT_LETRA);
      letra = (letra[0] || DEFAULT_LETRA);
      if (!ALPHA.includes(letra)) { setStatus("Letra inválida", "bad"); setError(`La letra debe ser una de: ${ALPHA.join("")}`); return; }

      // lectura corregida para tildes
      const text = await readFileTextWithEncoding(file);
      const { headers, data } = parseCSV(text);

      const needed = ["Nombre","Motivo","Fecha inicio","Fecha fin","Estado"];
      const missing = needed.filter(n => !headers.includes(n));
      if (missing.length) { setStatus("CSV no esperado", "bad"); setError("Faltan columnas: " + missing.join(", ")); return; }

      const p27 = data.filter(r => (r["Motivo"] || "").trim() === P27);

      const expanded = [];
      for (const r of p27) {
        const di = parseDateES(r["Fecha inicio"]);
        const df = parseDateES(r["Fecha fin"]);
        if (!di || !df) continue;

        const start = di <= df ? di : df;
        const end = di <= df ? df : di;

        for (const day of eachDayInclusive(start, end)) {
          if (withinInclusive(day, lectIni, lectFin)) {
            expanded.push({
              ...r,
              _day: day,
              lectiveDayISO: toISODate(day),
              _curso: cursoEscolarFromDate(day),
              _firstSurname: getFirstSurname(r["Nombre"]),
              _firstSurnameNorm: normalizeForSort(getFirstSurname(r["Nombre"])),
            });
          }
        }
      }

      if (!expanded.length) {
        setStatus("Sin P.27 lectivo", "");
        els.summary.innerHTML = `<p class="small">No hay P.27 dentro del periodo lectivo indicado.</p>`;
        els.tableWrap.innerHTML = `<p class="small">Nada que mostrar.</p>`;
        lastResultRows = []; lastResultHeaders = [];
        return;
      }

      const approvedCountByPersonCourse = new Map();
      const keyPersonCourse = (name, curso) => normalizeForSort(name) + "|" + curso;

      for (const e of expanded) {
        if (isEstadoAprobada(e["Estado"])) {
          const k = keyPersonCourse(e["Nombre"], e._curso);
          approvedCountByPersonCourse.set(k, (approvedCountByPersonCourse.get(k) || 0) + 1);
        }
      }

      const byDay = new Map();
      for (const e of expanded) {
        const k = e.lectiveDayISO;
        if (!byDay.has(k)) byDay.set(k, { approved: [], pending: [], rejected: [], all: [] });
        const b = byDay.get(k);
        b.all.push(e);
        if (isEstadoAprobada(e["Estado"])) b.approved.push(e);
        else if (isEstadoRechazada(e["Estado"])) b.rejected.push(e);
        else if (isEstadoPendiente(e["Estado"])) b.pending.push(e);
        else b.pending.push(e);
      }

      const resultRows = [];
      const summaryByDay = new Map();

      const dayKeys = Array.from(byDay.keys()).sort();
      for (const dayISO of dayKeys) {
        const bucket = byDay.get(dayISO);
        const occupied = bucket.approved.length;
        const free = Math.max(0, cupo - occupied);

        const pendingSorted = bucket.pending.slice().sort((a,b) => {
          const ka = keyPersonCourse(a["Nombre"], a._curso);
          const kb = keyPersonCourse(b["Nombre"], b._curso);
          const aHas = (approvedCountByPersonCourse.get(ka) || 0) > 0 ? 1 : 0;
          const bHas = (approvedCountByPersonCourse.get(kb) || 0) > 0 ? 1 : 0;
          if (aHas !== bHas) return aHas - bHas;

          const da = alphaKeyFromLetter(a._firstSurname, letra);
          const db = alphaKeyFromLetter(b._firstSurname, letra);
          if (da !== db) return da - db;

          if (a._firstSurnameNorm !== b._firstSurnameNorm) return a._firstSurnameNorm.localeCompare(b._firstSurnameNorm, "es");
          return normalizeForSort(a["Nombre"]).localeCompare(normalizeForSort(b["Nombre"]), "es");
        });

        const accepted = new Set();
        for (let i=0; i<pendingSorted.length; i++) if (i < free) accepted.add(pendingSorted[i]);

        let acceptedCount = 0, rejectedCount = 0;

        for (const e of bucket.approved) {
          resultRows.push({ ...e, decision: "YA APROBADA (ocupa cupo)", reason: `Cuenta como plaza ocupada. Cupo=${cupo}, ocupadas=${occupied}, huecos=${free}.` });
        }
        for (const e of bucket.rejected) {
          resultRows.push({ ...e, decision: "YA RECHAZADA", reason: "No se recalcula porque ya consta como rechazada en el CSV." });
        }
        for (const e of pendingSorted) {
          const kpc = keyPersonCourse(e["Nombre"], e._curso);
          const hadApproved = (approvedCountByPersonCourse.get(kpc) || 0);

          if (accepted.has(e)) {
            acceptedCount++;
            resultRows.push({
              ...e,
              decision: "ACEPTAR",
              reason: (hadApproved > 0)
                ? `Entra por cupo tras ordenación. (Ojo: ya tiene ${hadApproved} P.27 lectivo aprobado en ${e._curso}.)`
                : `Prioridad: no tiene P.27 lectivo aprobado en ${e._curso}. Entra por cupo.`,
            });
          } else {
            rejectedCount++;
            resultRows.push({
              ...e,
              decision: "FUERA DE CUPO",
              reason: (free === 0)
                ? `No hay huecos: cupo=${cupo}, ocupadas(aprobadas)=${occupied}.`
                : `Supera el cupo tras aplicar prioridad y desempate (letra ${letra}). Huecos=${free}.`,
            });
          }
        }

        summaryByDay.set(dayISO, {
          total: bucket.all.length,
          approved: bucket.approved.length,
          pending: bucket.pending.length,
          slots: cupo,
          accepted: acceptedCount,
          rejected: rejectedCount,
        });
      }

      const decisionRank = (d) => {
        if (d.startsWith("YA APROBADA")) return 0;
        if (d === "ACEPTAR") return 1;
        if (d.startsWith("FUERA")) return 2;
        if (d.startsWith("YA RECHAZADA")) return 3;
        return 9;
      };

      resultRows.sort((a,b) => {
        if (a.lectiveDayISO !== b.lectiveDayISO) return a.lectiveDayISO.localeCompare(b.lectiveDayISO);
        const ra = decisionRank(a.decision), rb = decisionRank(b.decision);
        if (ra !== rb) return ra - rb;
        return normalizeForSort(a["Nombre"]).localeCompare(normalizeForSort(b["Nombre"]), "es");
      });

      renderSummary(summaryByDay);
      renderTable(resultRows);

      lastResultHeaders = ["decision","lectiveDayISO","Nombre","Estado","Motivo","Fecha inicio","Fecha fin","reason"];
      lastResultRows = resultRows.map(r => ({
        decision: r.decision,
        lectiveDayISO: r.lectiveDayISO,
        Nombre: r["Nombre"],
        Estado: r["Estado"],
        Motivo: r["Motivo"],
        "Fecha inicio": r["Fecha inicio"],
        "Fecha fin": r["Fecha fin"],
        reason: r.reason,
      }));

      els.exportBtn.disabled = false;
      setStatus("Estado: Calculado", "ok");
    });

    return true;
  }

  (function waitForPermisos(){
    if (initPermisos()) return;
    setTimeout(waitForPermisos, 300);
  })();
  </script>
</body>
</html>
